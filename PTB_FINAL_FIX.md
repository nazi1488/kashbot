# üîß –§–∏–Ω–∞–ª—å–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ PTB –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π

## üö® –ü—Ä–æ–±–ª–µ–º–∞
–ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ `per_message=True` –ø–æ—è–≤–∏–ª–∏—Å—å –Ω–æ–≤—ã–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:
```
PTBUserWarning: If 'per_message=True', all entry points, state handlers, and fallbacks must be 'CallbackQueryHandler', since no other handlers have a message context.
```

## üí° –ö–æ—Ä–µ–Ω—å –ø—Ä–æ–±–ª–µ–º—ã
`per_message=True` —Ç—Ä–µ–±—É–µ—Ç, —á—Ç–æ–±—ã **–í–°–ï** –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –±—ã–ª–∏ —Ç–æ–ª—å–∫–æ `CallbackQueryHandler`, –Ω–æ –Ω–∞—à–∏ ConversationHandler –∏—Å–ø–æ–ª—å–∑—É—é—Ç:
- `MessageHandler` - –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç–µ–∫—Å—Ç–∞, —Ñ–∞–π–ª–æ–≤, URL
- `CommandHandler` - –¥–ª—è –∫–æ–º–∞–Ω–¥ –æ—Ç–º–µ–Ω—ã

## ‚úÖ –†–µ—à–µ–Ω–∏–µ
–£–±—Ä–∞–ª–∏ `per_message=True` –∏–∑ –≤—Å–µ—Ö ConversationHandler'–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç `MessageHandler`.

## üìã –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ ConversationHandler'—ã

### 1. `main.py`
- **broadcast_conv** (–∞–¥–º–∏–Ω —Ä–∞—Å—Å—ã–ª–∫–∞) - —É–±—Ä–∞–Ω `per_message=True`
- **cookies_conv** (–∞–¥–º–∏–Ω –∫—É–∫–∏) - —É–±—Ä–∞–Ω `per_message=True`  
- **conv_handler** (—É–Ω–∏–∫–∞–ª–∏–∑–∞—Ü–∏—è) - —É–±—Ä–∞–Ω `per_message=True`
- **hide_text_conv** (—Å–∫—Ä—ã—Ç–∏–µ —Ç–µ–∫—Å—Ç–∞) - —É–±—Ä–∞–Ω `per_message=True`
- **compress_conv** (—É–º–Ω–æ–µ —Å–∂–∞—Ç–∏–µ) - —É–±—Ä–∞–Ω `per_message=True`
- **video_download_conv** (—Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –≤–∏–¥–µ–æ) - —É–±—Ä–∞–Ω `per_message=True`

### 2. `features/keitaro/handlers.py`
- **conv_handler** (Keitaro –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è) - —É–±—Ä–∞–Ω `per_message=True`

## üîß –§–∏–Ω–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
```python
ConversationHandler(
    # ...
    per_user=True,
    per_chat=True  # –≥–¥–µ –Ω—É–∂–Ω–æ
    # per_message=True —É–±—Ä–∞–Ω–æ
)
```

## üéØ –ü–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ

1. **MessageHandler –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º —Å per_message=True**
   - MessageHandler –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ–±—ã—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
   - per_message=True —Ç—Ä–µ–±—É–µ—Ç —Ç–æ–ª—å–∫–æ CallbackQueryHandler
   
2. **–ò—Å—Ö–æ–¥–Ω—ã–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –±—ã–ª–∏ –º–µ–Ω–µ–µ –∫—Ä–∏—Ç–∏—á–Ω—ã**
   - `per_message=False` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ
   - CallbackQueryHandler –≤—Å–µ —Ä–∞–≤–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

3. **–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è**
   - –í—Å–µ ConversationHandler —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ –æ–∂–∏–¥–∞–µ—Ç—Å—è
   - –°–æ—Å—Ç–æ—è–Ω–∏—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞—é—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ

## üìä –°—Ç–∞—Ç—É—Å

- ‚úÖ **–ö—Ä–∏—Ç–∏—á–Ω—ã–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã**
- ‚úÖ **ConversationHandler'—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ**
- ‚úÖ **MessageHandler –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç –∏ —Ñ–∞–π–ª—ã**
- ‚úÖ **CallbackQueryHandler –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–Ω–æ–ø–∫–∏**

## üí≠ –í—ã–≤–æ–¥

`per_message=True` –ø–æ–¥—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è ConversationHandler'–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç **–∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ** CallbackQueryHandler. –î–ª—è —Å–º–µ—à–∞–Ω–Ω—ã—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ (Message + Callback) –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.

---
*–§–∏–Ω–∞–ª—å–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: 2025-09-29*  
*–í—Å–µ PTB –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏* ‚úÖ
