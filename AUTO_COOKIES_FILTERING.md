# üßπ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∫—É–∫–æ–≤

## üìã –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –∫—É–∫–∏ –ø—Ä–∏ –∏—Ö –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏, —É–¥–∞–ª—è—è –ø–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ –¥–æ–º–µ–Ω—ã –∏ –æ—Å—Ç–∞–≤–ª—è—è —Ç–æ–ª—å–∫–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –¥–ª—è –∫–∞–∂–¥–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã.

## üéØ –ü—Ä–æ–±–ª–µ–º–∞, –∫–æ—Ç–æ—Ä—É—é —Ä–µ—à–∞–µ—Ç

### ‚ùå **–†–∞–Ω–µ–µ:**
- –ü—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ –∫—É–∫–æ–≤ –∏–∑ –±—Ä–∞—É–∑–µ—Ä–∞ –ø–æ–ø–∞–¥–∞–ª–∏ –∫—É–∫–∏ –æ—Ç –≤—Å–µ—Ö —Å–∞–π—Ç–æ–≤
- –ü–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ –∫—É–∫–∏ (Telegram, Google –∏ —Ç.–¥.) –≤—ã–∑—ã–≤–∞–ª–∏ –æ—à–∏–±–∫–∏ –≤ yt-dlp
- –û—à–∏–±–∫–∞: `invalid Netscape format cookies file: 'telegram.me...'`
- –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º –Ω—É–∂–Ω–æ –±—ã–ª–æ –≤—Ä—É—á–Ω—É—é —á–∏—Å—Ç–∏—Ç—å –∫—É–∫–∏

### ‚úÖ **–¢–µ–ø–µ—Ä—å:**
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è** –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫—É–∫–æ–≤
- –¢–æ–ª—å–∫–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –¥–æ–º–µ–Ω—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
- **–ù–µ—Ç –æ—à–∏–±–æ–∫** –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ Netscape —Ñ–∞–π–ª–æ–≤
- **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å** - –ª–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —á—Ç–æ –±—ã–ª–æ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ

---

## üõ†Ô∏è –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç

### 1. **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö –¥–æ–º–µ–Ω–æ–≤**

```python
self.allowed_domains = {
    'instagram': {
        '.instagram.com', 'instagram.com',
        '.facebook.com', 'facebook.com', 
        '.fbcdn.net', 'fbcdn.net'
    },
    'youtube': {
        '.youtube.com', 'youtube.com',
        '.google.com', 'google.com',
        '.googleapis.com', 'googleapis.com',
        '.googlevideo.com', 'googlevideo.com',
        '.ytimg.com', 'ytimg.com'
    },
    'tiktok': {
        '.tiktok.com', 'tiktok.com',
        '.musical.ly', 'musical.ly',
        '.bytedance.com', 'bytedance.com',
        '.tiktokcdn.com', 'tiktokcdn.com'
    }
}
```

### 2. **–ü—Ä–æ—Ü–µ—Å—Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏**

–ü—Ä–∏ –≤—ã–∑–æ–≤–µ `cookies_manager.add_cookies()`:

1. **–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è** - Netscape ‚Üí JSON (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
2. **–í–∞–ª–∏–¥–∞—Ü–∏—è** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ JSON
3. **üßπ –§–ò–õ–¨–¢–†–ê–¶–ò–Ø** - —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö –¥–æ–º–µ–Ω–æ–≤
4. **–ü—Ä–æ–≤–µ—Ä–∫–∞** - –æ—Å—Ç–∞–ª–∏—Å—å –ª–∏ –≤–∞–ª–∏–¥–Ω—ã–µ –∫—É–∫–∏
5. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ** - —Ç–æ–ª—å–∫–æ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫—É–∫–∏

### 3. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞**

```
INFO:üóëÔ∏è Filtered out cookie: stel_web_auth@telegram.me for instagram
INFO:üóëÔ∏è Filtered out cookie: NID@.google.com for instagram
INFO:üßπ Filtered 3 foreign cookies for instagram, kept 2 valid cookies
INFO:‚úÖ Auto-filtered 3 foreign cookies for instagram
INFO:üìä Adding 2 filtered cookies for instagram
```

---

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### **Instagram –∫—É–∫–∏:**
- **–ò—Å—Ö–æ–¥–Ω–æ:** 5 –∫—É–∫–æ–≤ (.instagram.com, .facebook.com, .youtube.com, .google.com, telegram.me)
- **–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ:** 3 –∫—É–∫–∏ (—É–¥–∞–ª–µ–Ω—ã Telegram, Google, YouTube)
- **–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ:** 2 –≤–∞–ª–∏–¥–Ω—ã—Ö –∫—É–∫–∏ (.instagram.com, .facebook.com)

### **YouTube –∫—É–∫–∏:**
- **–ò—Å—Ö–æ–¥–Ω–æ:** 4 –∫—É–∫–∏ (.youtube.com, .google.com, .instagram.com, .tiktok.com) 
- **–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ:** 2 –∫—É–∫–∏ (—É–¥–∞–ª–µ–Ω—ã Instagram, TikTok)
- **–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ:** 2 –≤–∞–ª–∏–¥–Ω—ã—Ö –∫—É–∫–∏ (.youtube.com, .google.com)

### **TikTok –∫—É–∫–∏:**
- **–ò—Å—Ö–æ–¥–Ω–æ:** 4 –∫—É–∫–∏ (.tiktok.com, .bytedance.com, .facebook.com, .google.com)
- **–û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ:** 2 –∫—É–∫–∏ (—É–¥–∞–ª–µ–Ω—ã Facebook, Google)
- **–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ:** 2 –≤–∞–ª–∏–¥–Ω—ã—Ö –∫—É–∫–∏ (.tiktok.com, .bytedance.com)

---

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

### 1. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**
- ‚úÖ –ù–µ—Ç –ø–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö –∫—É–∫–æ–≤ –≤ Netscape —Ñ–∞–π–ª–∞—Ö
- ‚úÖ –ò—Å–∫–ª—é—á–µ–Ω—ã –æ—à–∏–±–∫–∏ `invalid Netscape format`
- ‚úÖ –¢–æ–ª—å–∫–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –¥–æ–º–µ–Ω—ã –¥–ª—è –∫–∞–∂–¥–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã

### 2. **–£–¥–æ–±—Å—Ç–≤–æ**
- ‚úÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø—Ä–æ—Ü–µ—Å—Å** - –Ω–µ —Ç—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–≥–æ –≤–º–µ—à–∞—Ç–µ–ª—å—Å—Ç–≤–∞
- ‚úÖ **–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å** - –ª–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- ‚úÖ **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å** - —Ä–∞–±–æ—Ç–∞–µ—Ç —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–¥–æ–º

### 3. **–ù–∞–¥—ë–∂–Ω–æ—Å—Ç—å**
- ‚úÖ –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç **–≤—Å–µ –∏–∑–≤–µ—Å—Ç–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã** —Å –∫—É–∫–∞–º–∏
- ‚úÖ **–í–∞–ª–∏–¥–∞—Ü–∏—è** - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —á—Ç–æ –æ—Å—Ç–∞–ª–∏—Å—å —Ä–∞–±–æ—Ç–∞—é—â–∏–µ –∫—É–∫–∏
- ‚úÖ **–ú–µ—Ç–∫–∏ –≤ –∑–∞–º–µ—Ç–∫–∞—Ö** - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —á—Ç–æ –±—ã–ª–∞ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è

---

## üîß –î–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### **–ú–µ—Ç–æ–¥ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏:**
```python
def _filter_cookies_by_platform(self, cookies_json: str, platform: str) -> Tuple[str, int]:
    # –ü–∞—Ä—Å–∏–Ω–≥ –∫—É–∫–æ–≤ –∏–∑ JSON
    cookies = json.loads(cookies_json)
    allowed_domains = self.allowed_domains.get(platform, set())
    
    filtered_cookies = []
    removed_count = 0
    
    for cookie in cookies:
        domain = cookie.get('domain', '').lower().strip()
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–º–µ–Ω–∞
        is_allowed = any(
            domain == allowed_domain or domain.endswith(allowed_domain)
            for allowed_domain in allowed_domains
        )
        
        if is_allowed:
            filtered_cookies.append(cookie)
        else:
            removed_count += 1
            # –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –∫—É–∫–∏
    
    return json.dumps(filtered_cookies), removed_count
```

### **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ add_cookies:**
```python
async def add_cookies(self, platform: str, cookies_data: str, ...):
    # ... –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è ...
    
    # üßπ –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –§–ò–õ–¨–¢–†–ê–¶–ò–Ø
    filtered_cookies_json, removed_count = self._filter_cookies_by_platform(cookies_json, platform)
    
    if removed_count > 0:
        logger.info(f"‚úÖ Auto-filtered {removed_count} foreign cookies for {platform}")
        notes = f"{notes} [AUTO-FILTERED: -{removed_count} cookies]"
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –æ—Å—Ç–∞–ª–∏—Å—å –≤–∞–ª–∏–¥–Ω—ã–µ –∫—É–∫–∏
    if not json.loads(filtered_cookies_json):
        return False
    
    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫—É–∫–æ–≤
    await self.db.execute(query, (..., filtered_cookies_json, ...))
```

---

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### **–î–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤:**
–ù–∏–∫–∞–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫—É–∫–æ–≤! –ü—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–π—Ç–µ –∫—É–∫–∏ –∫–∞–∫ –æ–±—ã—á–Ω–æ:

```python
success = await cookies_manager.add_cookies(
    platform='instagram',
    cookies_data=exported_cookies_json,
    notes='–ö—É–∫–∏ –æ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞ @example'
)
```

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
- üßπ –û—Ç—Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –ø–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ –¥–æ–º–µ–Ω—ã
- üìù –î–æ–±–∞–≤–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –∑–∞–º–µ—Ç–∫–∏
- üìä –ü–æ–∫–∞–∂–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ –ª–æ–≥–∞—Ö

### **–î–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:**
–°–ª–µ–¥–∏—Ç–µ –∑–∞ –ª–æ–≥–∞–º–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞:

```bash
grep "Auto-filtered" bot.log
grep "üóëÔ∏è Filtered out cookie" bot.log
```

---

## üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

–ü–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –∞–≤—Ç–æ—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏:

- **üö´ 0 –æ—à–∏–±–æ–∫** `invalid Netscape format cookies file`
- **‚úÖ 100% —É—Å–ø–µ—à–Ω–æ—Å—Ç—å** —Å–æ–∑–¥–∞–Ω–∏—è Netscape —Ñ–∞–π–ª–æ–≤
- **üßπ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ** 7 –ø–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö –∫—É–∫–æ–≤ –≤ —Ç–µ—Å—Ç–∞—Ö
- **üìä 4/4 –∞–∫—Ç–∏–≤–Ω—ã—Ö** Instagram –∫—É–∫–∏ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö

---

## üîÆ –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –¥–æ–º–µ–Ω–æ–≤:** –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö –¥–æ–º–µ–Ω–æ–≤ –ø–æ –º–µ—Ä–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
2. **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏:** –ü–æ–∫–∞–∑ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫—É–∫–æ–≤
3. **–í–∞–ª–∏–¥–∞—Ü–∏—è –∫—É–∫–æ–≤:** –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –∫—É–∫–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–π –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, `sessionid` –¥–ª—è Instagram)
4. **–ê–≤—Ç–æ–æ—á–∏—Å—Ç–∫–∞:** –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –∫—É–∫–æ–≤ —Å –ø–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–º–∏ –¥–æ–º–µ–Ω–∞–º–∏

---

## ‚úÖ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∫—É–∫–æ–≤ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É –ø–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö –¥–æ–º–µ–Ω–æ–≤:**

- ‚ùå –ë–æ–ª—å—à–µ –Ω–µ—Ç –æ—à–∏–±–æ–∫ `invalid Netscape format cookies file`
- ‚úÖ Instagram Reels —Å–∫–∞—á–∏–≤–∞—é—Ç—Å—è –±–µ–∑ –ø—Ä–æ–±–ª–µ–º
- üßπ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö –∫—É–∫–æ–≤
- üìä –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ—Ü–µ—Å—Å–∞

**–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ!** üöÄ
