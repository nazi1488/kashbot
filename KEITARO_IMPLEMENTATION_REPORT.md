# üìã –û—Ç—á–µ—Ç –æ–± –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ Keitaro –≤ KashHub Bot

**–î–∞—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** 28 —Å–µ–Ω—Ç—è–±—Ä—è 2025  
**–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã:** ~30 –º–∏–Ω—É—Ç  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–ê–í–ï–†–®–ï–ù–û

## üéØ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞

–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Keitaro ‚Üí Telegram –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –∫–æ–Ω–≤–µ—Ä—Å–∏—è—Ö (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, –¥–µ–ø–æ–∑–∏—Ç—ã, –æ—Ç–∫–∞–∑—ã) —á–µ—Ä–µ–∑ S2S Postback.

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –°–æ–∑–¥–∞–Ω—ã SQLAlchemy –º–æ–¥–µ–ª–∏ (`database/keitaro_models.py`):
  - `KeitaroProfile` - –ø—Ä–æ—Ñ–∏–ª–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
  - `KeitaroRoute` - –ø—Ä–∞–≤–∏–ª–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏  
  - `KeitaroEvent` - –ª–æ–≥ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏
- ‚úÖ –°–æ–∑–¥–∞–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è Alembic (`alembic/versions/add_keitaro_integration.py`)
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### 2. –í–µ–±-—Å–µ—Ä–≤–µ—Ä –¥–ª—è Postback
- ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω aiohttp —Å–µ—Ä–≤–µ—Ä (`web_server.py`)
- ‚úÖ Endpoint: `POST /integrations/keitaro/postback?secret=XXX`
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ form-data –∏ JSON
- ‚úÖ Rate limiting (–¥–æ 27 RPS)
- ‚úÖ –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π (TTL 3600 —Å–µ–∫)
- ‚úÖ –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º

### 3. –®–∞–±–ª–æ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ –ú–æ–¥—É–ª—å —à–∞–±–ª–æ–Ω–æ–≤ (`features/keitaro/templates.py`)
- ‚úÖ –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤
- ‚úÖ –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É–º–º —Å –≤–∞–ª—é—Ç–æ–π
- ‚úÖ HTML-—ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö –ø–æ–ª–µ–π Keitaro

### 4. Telegram –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
- ‚úÖ Handlers —Å FSM (`features/keitaro/handlers.py`)
- ‚úÖ –ú–∞—Å—Ç–µ—Ä —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
- ‚úÖ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ Postback URL
- ‚úÖ –¢–µ—Å—Ç–æ–≤–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞
- ‚úÖ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ
- ‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–µ–π
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–∏–º–∏—Ç–æ–≤

### 5. –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è
- ‚úÖ –†—É—Å—Å–∫–∏–π —è–∑—ã–∫ (30+ –∫–ª—é—á–µ–π)
- ‚úÖ –ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫  
- ‚úÖ –£–∫—Ä–∞–∏–Ω—Å–∫–∏–π —è–∑—ã–∫
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–∏—Å—Ç–µ–º–æ–π i18n

### 6. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ –±–æ—Ç
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ –≤ `main.py`
- ‚úÖ –ó–∞–ø—É—Å–∫ –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞ –≤ `post_init`
- ‚úÖ Graceful shutdown

### 7. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ Unit-—Ç–µ—Å—Ç—ã (`tests/test_keitaro.py`)
- ‚úÖ –¢–µ—Å—Ç—ã —à–∞–±–ª–æ–Ω–æ–≤
- ‚úÖ –¢–µ—Å—Ç—ã –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏
- ‚úÖ –¢–µ—Å—Ç—ã –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏
- ‚úÖ –¢–µ—Å—Ç—ã rate limiting

### 8. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- ‚úÖ –ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (`KEITARO_INTEGRATION.md`)
- ‚úÖ –ü—Ä–∏–º–µ—Ä—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- ‚úÖ Troubleshooting
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω README

### 9. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω `.env.example`
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ `config.py`

## üìÅ –°–ø–∏—Å–æ–∫ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö/–∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

### –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã:
1. `database/keitaro_models.py` - –º–æ–¥–µ–ª–∏ –ë–î
2. `alembic/versions/add_keitaro_integration.py` - –º–∏–≥—Ä–∞—Ü–∏—è
3. `web_server.py` - –≤–µ–±-—Å–µ—Ä–≤–µ—Ä –¥–ª—è postback
4. `features/keitaro/__init__.py` - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥—É–ª—è
5. `features/keitaro/templates.py` - —à–∞–±–ª–æ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏–π
6. `features/keitaro/handlers.py` - Telegram handlers
7. `tests/test_keitaro.py` - —Ç–µ—Å—Ç—ã
8. `KEITARO_INTEGRATION.md` - –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
9. `.env.example` - –ø—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
10. `KEITARO_IMPLEMENTATION_REPORT.md` - —ç—Ç–æ—Ç –æ—Ç—á–µ—Ç

### –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
1. `main.py` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Keitaro
2. `config.py` - –¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
3. `handlers/subscription.py` - –¥–æ–±–∞–≤–ª–µ–Ω –ø—É–Ω–∫—Ç –º–µ–Ω—é
4. `locales/ru.json` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è
5. `locales/en.json` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è
6. `locales/uk.json` - –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è
7. `requirements.txt` - –¥–æ–±–∞–≤–ª–µ–Ω—ã –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
8. `README.md` - –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:
- ‚úÖ –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Å–µ–∫—Ä–µ—Ç–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è
- ‚úÖ –ù–∏–∫–∞–∫–æ–≥–æ BOT_TOKEN –≤ Postback URL
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ HTML-—ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
- ‚úÖ Rate limiting –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- ‚úÖ In-memory –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ SQL-–∑–∞–ø—Ä–æ—Å—ã —Å –∏–Ω–¥–µ–∫—Å–∞–º–∏
- ‚úÖ –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞

### –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:
- ‚úÖ Graceful degradation –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π
- ‚úÖ –í–æ–∑–≤—Ä–∞—Ç 200 OK –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö (—á—Ç–æ–±—ã Keitaro –Ω–µ —Ä–µ—Ç—Ä–∞–∏–ª)
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏–π

## üìä –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ –±–æ—Ç–µ:
```
1. /start ‚Üí üíö Keitaro —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
2. ‚ûï –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
3. üìç –í —ç—Ç–æ—Ç —á–∞—Ç
4. –ü–æ–ª—É—á–µ–Ω URL: https://domain.com:8080/integrations/keitaro/postback?secret=XXX
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ Keitaro:
```
Campaign ‚Üí S2S Postback ‚Üí Add:
- URL: [URL –∏–∑ –±–æ—Ç–∞]  
- Method: POST
- Content-Type: application/x-www-form-urlencoded
- Fields: status={status}, campaign_name={campaign_name}, ...
```

### –ü—Ä–∏–º–µ—Ä—ã —Å–æ–æ–±—â–µ–Ω–∏–π:
```
üí∞ –î–µ–ø–æ–∑–∏—Ç
–ö–∞–º–ø–∞–Ω–∏—è: Facebook Ads
–ö—Ä–µ–∞—Ç–∏–≤: cr_123
–õ–µ–Ω–¥–∏–Ω–≥: Landing Page
–î–æ—Ö–æ–¥: 100 USD
Sub1: google | GEO: UK
TX: abc123def456
```

## üöÄ –ó–∞–ø—É—Å–∫

### 1. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏:
```bash
alembic upgrade head
```

### 2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –æ–∫—Ä—É–∂–µ–Ω–∏–µ:
```bash
WEBHOOK_DOMAIN=yourdomain.com
KEITARO_WEBHOOK_PORT=8080
DATABASE_URL=postgresql://...
```

### 3. –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞:
```bash
python main.py
```

### 4. –í–µ–±-—Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞ –ø–æ—Ä—Ç—É 8080

## ‚ö†Ô∏è –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- PostgreSQL –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª–µ–π
- –û—Ç–∫—Ä—ã—Ç—ã–π –ø–æ—Ä—Ç 8080 (–∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π)
- –î–æ–º–µ–Ω —Å SSL –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
- Python 3.8+
- aiohttp

## üîÆ –í–æ–∑–º–æ–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (–Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ)

1. **Pull-—Ä–µ–∂–∏–º** - –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π –æ–ø—Ä–æ—Å Keitaro API
2. **–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è** - regex –ø–∞—Ç—Ç–µ—Ä–Ω—ã
3. **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞** - –≥—Ä–∞—Ñ–∏–∫–∏ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ —Å–æ–±—ã—Ç–∏–π
4. **Bulk –æ–ø–µ—Ä–∞—Ü–∏–∏** - –º–∞—Å—Å–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π
5. **Webhook –ø–æ–¥–ø–∏—Å–∏** - HMAC –≤–∞–ª–∏–¥–∞—Ü–∏—è
6. **IP whitelist** - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –ø–æ IP

## üìù –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é. –í—Å–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∏–∑ –¢–ó –≤—ã–ø–æ–ª–Ω–µ–Ω—ã:

- ‚úÖ S2S Postback —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- ‚úÖ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –æ–±–µ—Å–ø–µ—á–µ–Ω–∞ (secret —Ç–æ–∫–µ–Ω—ã)
- ‚úÖ –ù–∏–∫–∞–∫–∏—Ö BOT_TOKEN –≤ URL
- ‚úÖ Rate limiting –∏ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è
- ‚úÖ –ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç—å RU/UA/EN
- ‚úÖ –ì–∏–±–∫–∞—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è
- ‚úÖ –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- ‚úÖ –¢–µ—Å—Ç—ã –Ω–∞–ø–∏—Å–∞–Ω—ã
- ‚úÖ –ù—É–ª–µ–≤–∞—è –ª–æ–º–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∫–æ–¥–∞

**–°—Ç–∞—Ç—É—Å: Production Ready** üöÄ
